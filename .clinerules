# PolyForge Engine - Developer Guidelines & SOP

## 0. Tech Stack & Core Context (核心技术栈)
- **Framework**: React 18+ (Functional Components + Hooks only).
- **Styling**: TailwindCSS (Utility-first).
- **3D Engine**: Three.js + React-Three-Fiber (R3F) + Drei.
- **Language**: TypeScript (Strict Mode).
- **State**: React Context + Custom EventBus (No Redux unless specified).

## 1. 🛡️ Security & Stability (安全红线)
- **Code Integrity**: 每次生成代码必须自我检查末尾的 `}` 或 `);` 是否闭合。严禁输出截断的代码。
- **No Blind Overwrites**: 修改复杂文件时，优先使用 `apply_diff`。如果必须重写，请确保上下文完整。
- **System Safety**: 严禁修改系统级配置或自动运行服务器命令。
- **Destructive Actions**: 删除核心文件前必须请求批准。

## 2. 🧱 Architecture & Code Quality (架构与质量)
- **Defensive Programming**:
  - UI 渲染必须兼容数据缺失的情况 (使用 `?.` 或 `??`)，**目标是 Zero-Crash (零崩溃)**。
  - 遇到数据结构不匹配，优先降级显示 (Fallback)，而不是让程序报错中断。
- **Event-Driven**: 模块间通信优先考虑 `EventBus`，保持解耦。
- **Modularization**: 提倡组件原子化，当单个文件逻辑过于复杂时，主动建议拆分。

## 3. 🌍 3D Standards & Flexibility (3D 标准与灵活性)
- **Data-Driven Transforms**:
  - **Soft Rules**: 避免在代码中 Hardcode 坐标数值。
  - **Configurable Root**: 角色和物体应包含一个可调整的 `Root Container`。
  - **User Control**: 关于“入土”或“悬浮”的问题，优先提供 UI 参数让用户调整，而不是在代码里写死偏移量。
- **Performance**: 避免在同一坐标重叠渲染不必要的 Mesh (Z-Fighting)。

## 4. 🎨 i18n & Aesthetics (国际化与审美)
- **Sync Locales**: 修改 UI 文字时，记得同步 `zh.json` 和 `en.json`。
- **Terminology**: 保持专业术语的翻译准确性（保留英文原词）。

## 5. 🔄 Workflow SOP (工作流标准)
- **Refactoring**: 优化代码时，请遵循“小步快跑”原则，确保每一步都能运行。
- **New Features**: 先查阅现有库，复用轮子；再定义接口；最后实现 UI。
- **Cleanup**: 废弃代码建议先标记 `// DEPRECATED`，确认无误后再物理删除。

## 6. 🧠 Thinking Protocol (高维思维模型 - 关键!)
**在执行任何指令前，请按以下步骤思考：**
1.  **Context Analysis (上下文分析)**:
    - 用户想要修改的功能属于哪个模块？
    - 这个修改会影响到哪些关联文件（如 `types.ts`, `EventBus`）？
2.  **Impact Check (影响评估)**:
    - 如果我改了这个 UI，会导致 3D 场景重新渲染吗？
    - 如果数据是空的，我的代码会黑屏吗？
3.  **Creative Solution (创造性解题)**:
    - **不要死板地执行命令**。如果用户的指令会导致显而易见的 Bug 或坏味道，**请主动提出更好的替代方案**。
    - *Example*: "用户让我把模型写死在 Y=1.5，但我应该建议用户添加一个 Slider 来动态调整。"
4.  **Verification (自我验证)**:
    - 代码写完了吗？括号闭合了吗？类型定义对齐了吗？

## 7. ⚖️ Rule Override (规则豁免权)
- **Common Sense Rule**: 如果上述规则在特定场景下严重阻碍了功能的实现或导致了极差的代码体验，**请忽略规则，并明确告知我你为什么要打破规则**。我们要的是结果，不是教条。