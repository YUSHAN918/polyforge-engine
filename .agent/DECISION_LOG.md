# 技术决策与阶段进度日志 (Decision Log)

## 📅 2026-01-03: 第一人称相机 (FPS) 防穿模与零延迟同步
- **决策背景**：体验模式下的第一人称视角存在严重穿模：摄像机坐标默认位于角色胶囊体圆心，导致玩家看到模型内部（内脏感）。同时，角色移动时相机存在明显的“物理滞后”，导致镜头脱离感。
- **核心决策**：
    1.  **防穿模偏移算法 (V2)**：放弃不可靠的 Socket 局部跟随，在 `FirstPersonStrategy.ts` 中实现基于主世界坐标的 **0.6m 前向推移**（Yaw 相关）+ **1.7m 高度修复**。
    2.  **强制零延迟插值**：在 `CameraSystem.ts` 的 `smoothUpdate` 中，对 `firstPerson` 模式强制设置 `t = 1.0`（插值系数 1.0），物理坐标 1:1 强锁，彻底消除插值延迟。
    3.  **引用环境补全**：修复了策略类中缺失的 `THREE` 库引入。
- **影响结果**：
    *   第一人称视野正常化，不再“看内脏”。
    *   操作手感达到 FPS 级别（即时响应），无镜头拖拽感。
    *   系统整体稳定性提升，消除了控制台运行时报错。

---

## 📅 2026-01-03: 音频指挥部 (Audio Hub) 物理级加固与 UI 描述重构
- **背景**：音频系统在长时间运行或频繁切换极易出现“静默崩溃”与“断点丢失”。资产列表中的音频条目因缺失文字描述导致制作人陷入“盲选”困境。
- **核心决策**：
    1.  **物理锁止位 (`manualStopped`)**：在 `AudioNodeEntry` 中引入锁止状态，物理隔离了 Web Audio 的 `onended` 清理事件与人为暂停行为，确保断点节点不被误删。
    2.  **元数据持久化扩展**：物理扩展了 `AssetMetadata` 接口，使资产注册阶段即可捕获音频时长、采样率等关键几何信息，为 UI 侧提供真值来源。
    3.  **UI 描述增强 (HUD Mode)**：在 `AssetItem` 中实装玻璃态描述层，直接在预览图上叠加文件名与子分类标签（BGM/SFX），彻底解决分类盲区。
    4.  **交互对齐协议**：点击列表预览按钮调整为触发 `TOGGLE_PAUSE` 逻辑，而非暴力的 `STOP/PLAY`，最大程度利用断点续播。
- **局限性说明**：受限于 Web Audio 缓冲区在复杂 ECS 循环中的采样同步瓶颈，全量续播在极端倍速下仍存在毫秒级偏移风险。当前决定将系统稳定在“防删锁止 + 强视觉反馈”状态，作为 Phase 13 的合规基线。
- **状态**：**✅ 核心加固交付**。

## 📅 2026-01-03 晚：神经通信加固 (Neural Connectivity) 与互斥控制
- **背景**：在 Phase 13/20 的最终验收中发现，音频资产库存在“图标二次点击反馈”延迟以及预览音轨重叠交响的交互缺陷。
- **核心决策**：
    1.  **全局事件总线锚定 (`EventBus Global Sync`)**：由于 `AudioSystem` 在核心层与 R3F/React 环境存在物理隔离，决策将 `EventBus` 提升至全局 `window` 级别，建立了跨层级的高阶状态更新热线。
    2.  **独占式预览锁 (`Mutual Exclusivity`)**：在 `playAudio` 入口强制引入“排他性检查”。任何新的预览音轨启动前必须物理杀死所有正在运行的影子预览节点，确保声场唯一性。
    3.  **Revision 穿透状态同步**：UI 侧强制监听 `ENGINE_STATE_CHANGED` 信号并映射为 `revision` 状态，实现了“引擎动作-UI 图标”的毫秒级真值对齐。
- **状态**：**✅ 交互体验全闭环交付**。

---

## 📅 2026-01-02: 性能优化会战 - 创造模式 FPS 危机修复
- **背景**：制作人发现创造模式下出现严重卡顿：点击画面会导致 FPS 掉到个位数，拖动滑块异常卡顿。
- **核心修复**：
    1.  **点击掉帧修复**：击中地形/植被后立即拦截 Raycast 后续逻辑，跳过 Outline 遍历。
    2.  **植被生成优化**：风力/高度滑块通过 Shader Uniform 实时更新，不再标记 `isDirty` 重新生成实例。
    3.  **IO 频率治理**：移除了 `VegetationSystem` 每帧的双重遍历检查。
    4.  **地形扩大策略**：禁用地形扩大时的自动植被重新分布，避免大场景死锁。
- **状态**：**✅ 任务闭环**。FPS 恢复至 60 帧稳定。

---

## 📅 2026-01-02: 贴纸 (Sticker) 渲染深度与阴影策略优化
- **背景**：在图片放置系统中，贴纸模式（Sticker）存在严重的 Z-Fighting（深度冲突闪烁）现象，且受引擎全局后处理与阴影影响。
- **核心决策**：
    1.  **渲染排序重组**：为贴纸赋予 `renderOrder = 10`。
    2.  **物理深度脱钩**：禁用深度写入 (`depthWrite = false`)，并启用 `polygonOffset`（偏移量 -4.0）。
    3.  **阴影隔离**：禁用贴纸的 `castShadow` 与 `receiveShadow`，防止自影干扰。
- **状态**：**✅ 修复完成**。

---

## 📅 2026-01-02: 图片资产三模态持久化设计与功能补全
- **背景**：图片资产存在"白色方块"、"单面可见"、"无法选中"等问题。
- **核心决策**：
    1.  **渲染增强**：支持 PNG 透明通道与双面渲染 (`DoubleSide`)。
    2.  **物理闭环**：放置时自动生成薄盒碰撞体，统一射线选中逻辑。
    3.  **行为持久化**：重构 `PlacementSystem`，使其在放置后仍能驱动 Billboard 与 Standee 行为。
- **状态**：**✅ 修复完成**。

---

## 📅 2026-01-02: 物理系统坐标系归一化 (Physics Normalization)
- **背景**：当模型缩放不为 1 时，物理碰撞盒偏移量会发生空间漂移。
- **核心决策**：
    1.  **归一化局部空间**：重构计算公式，将用户偏置与基础偏置求和后，统一乘以实体的 `Transform.scale`。
    2.  **公式变更**：由 `(BaseOffset * Scale) + LocalOffset` 修正为 `(BaseOffset + LocalOffset) * Scale`。
- **影响结果**：模型重载、缩放后的物理错位问题彻底解决。

---

## 📅 2026-01-02: 创造模式资产变换系统重构
- **核心决策**：采用键盘驱动的“变换矩阵”方案（Q/E/R/G/[ ]/W/S），参考 Blender 引入 `G` (Grab) 键，将被选物体临时转为“幽灵态”复用放置逻辑。
- **结论**：大幅提升了场景搭建的速度和精准度。

---

## 📅 2025-12-28: 相机系统稳定性与输入锚点修复
- **更正内容**：移除重复 `smoothUpdate`，稳固输入重置锚点 `inputSystem.resetFrameData()` 至每一帧逻辑最末端，解决输入“粘连”风险。

---

## 📅 2025-12-28: 物理方块不可见逻辑修复
- **修正**：显式指定 `createEntity(name, id)`，统一使用 `entity.id` 挂载组件，修复因 ID 识别错误导致的无组件方块。

---

## 📅 2025-12-28: [重大事故复盘] 资产界面功能全量退化
- **根因**：Orbital Command 重构时过度简化，丢失了 Assets 模块的多维分类预览逻辑。
- **补救**：从 `AssetLibraryPanel.tsx` 提取分类导航逻辑并重新注入。

---

## 📅 2025-12-27: 渲染管线抗锯齿升级 (SMAA)
- **修正**：用 `SMAAPass` 替换旧版 `FXAAShader`，优化 Pass 顺序以消除 Windows 环境下的 Shader Warning。

---

## 📅 2025-12-26: 超级个体进化 - 山神 (Universal Generalist)
- **核心决策**：撤销 Architect/Builder 分体负载，整合为单一全能实体——**“山神”**，确立全职合伙人制。

---

## 📅 2025-12-26: Phase 13.0a 交互重构 (Orbital Command) 交付
- **内容**：实装 HUD 顶部状态栏、Tab 中控台与折叠底盘，大幅提升人机交互净空比。

---

## 📅 2025-12-25: Phase 13.0 架构可视化验收
- **内容**：完成从底层到 UI 的全量桥接，清理了“灰度 Demo”遗留操作成本。

---

## 📅 2025-12-25: 植被修复全链路交付
- **内容**：实现 `VegetationSystem.ts` GPU 侧缩放逻辑与世界空间风场。

---

## 📅 2025-12-25: 植被修复方案架构审计
- **结论**：审计通过，确定影子构建合规，建议性能重点压入 Vertex Shader。

---

## 📅 2025-12-25: 记忆基地初始化
- **内容**：正式启用 `.agent/` 记忆仓库，确立“Joyful Development”愿景。
